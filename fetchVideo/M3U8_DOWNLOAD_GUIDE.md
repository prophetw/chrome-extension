# M3U8 下载说明

## 什么是 M3U8？

M3U8 是 HTTP Live Streaming (HLS) 的播放列表文件格式，包含了视频流的分片信息。它不是视频文件本身，而是一个指向多个视频片段（通常是 .ts 文件）的索引文件。

## 下载流程

当你点击下载 M3U8 视频时，扩展程序会执行以下步骤：

### 1. 解析阶段
- ✅ 获取 M3U8 文件内容
- ✅ 解析播放列表，提取所有视频片段链接
- ✅ 处理相对路径，转换为完整的 URL

### 2. 下载阶段
- ✅ 逐个下载视频片段（.ts 文件）
- ✅ 显示下载进度（片段数量/总数量）
- ✅ 将片段保存到临时文件夹

### 3. 文件组织
下载的文件会按以下结构保存：
```
Downloads/
  FetchVideo/
    temp/
      [任务ID]/
        segment_0000.ts
        segment_0001.ts
        segment_0002.ts
        ...
```

## 特殊标识

在视频列表中，M3U8 视频会有以下特殊标识：

- 🎬 **图标标识**：表示这是 HLS 流媒体
- **格式显示**：显示为 "🎬 HLS (M3U8)"
- **颜色标识**：左边有绿色边框
- **鼠标悬停提示**：显示 "HTTP Live Streaming - 将分段下载并自动合并"

## 下载注意事项

### ✅ 支持的功能
- 自动解析 M3U8 播放列表
- 分段下载视频片段
- 进度通知和状态显示
- 相对路径自动转换
- 下载失败的片段会跳过并继续

### ⚠️ 当前限制
- 需要手动合并视频片段（使用 FFmpeg 等工具）
- 暂不支持加密的 M3U8 流
- 暂不支持自适应比特率的多质量流选择

## 合并视频片段

下载完成后，你可以使用以下方法合并视频片段：

### 使用 FFmpeg（推荐）
```bash
# 进入片段所在目录
cd Downloads/FetchVideo/temp/[任务ID]/

# 合并所有 .ts 文件
ffmpeg -i "concat:segment_0000.ts|segment_0001.ts|segment_0002.ts|..." -c copy output.mp4

# 或使用文件列表方式
ls segment_*.ts | sort -V > filelist.txt
ffmpeg -f concat -safe 0 -i filelist.txt -c copy output.mp4
```

### 在线工具
你也可以使用在线视频合并工具来合并下载的片段。

## 故障排除

### 下载失败
- 检查网络连接
- 确认 M3U8 链接有效
- 某些网站可能有防盗链保护

### 片段缺失
- 部分片段下载失败是正常的
- 可以手动下载失败的片段
- 或跳过缺失片段进行合并

### 合并问题
- 确保片段顺序正确
- 检查片段文件完整性
- 使用专业工具如 FFmpeg

## 技术细节

### M3U8 解析
扩展程序会解析以下 M3U8 标签：
- `#EXTM3U`：文件标识
- `#EXTINF`：片段时长信息
- `#EXT-X-ENDLIST`：播放列表结束

### URL 处理
- 相对路径自动转换为绝对路径
- 支持不同的 URL 格式
- 处理 URL 参数和查询字符串

### 下载优化
- 串行下载避免服务器压力
- 自动重试失败的下载
- 智能延迟控制
